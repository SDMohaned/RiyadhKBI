<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة المؤشرات المالية للبلديات</title>

  <!-- ArcGIS JS (AMD) -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>

  <style>
    :root{
      --bg:#f8fafc;        /* خلفية فاتحة جدًا */
      --fg:#0f172a;        /* نص داكن */
      --muted:#64748b;     /* نص ثانوي */
      --brand:#0ea5e9;     /* أزرق */
      --accent:#22c55e;    /* أخضر */
      --frame:#000000;     /* حدود سوداء 2px */
      --white:#ffffff;     /* أبيض */
      --grey:#9ca3af;      /* رمادي للأعمدة المستهدفة */
    }
    html, body { height: 100%; margin: 0; font-family: "Cairo", system-ui, sans-serif; background: var(--bg); color: var(--fg); }
    .panel   { margin: 14px auto; max-width: 1420px; background: var(--white); padding: 16px; border-radius: 14px; box-shadow: 0 2px 8px rgba(0,0,0,.06); border:2px solid var(--frame); }
    #viewDiv { height: 560px; border-radius: 12px; margin-bottom: 12px; border:2px solid var(--frame); }
    .toolbar { display:flex; gap:12px; align-items:flex-end; margin-bottom:12px; flex-wrap: wrap; }
    .toolbar h2 { margin:0; color: var(--brand); }
    .muted { color:var(--muted); font-size:.9em; }
    .fld { display:flex; flex-direction:column; gap:4px; }
    .in { border: 2px solid var(--frame); border-radius:12px; padding:8px 12px; min-width: 170px; background:var(--white); }
    .btn { border:2px solid var(--frame); background:var(--white); border-radius:12px; padding:8px 14px; cursor:pointer; }
    .btn:hover { background:#e2f2ff; }

    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(230px,1fr)); gap: 12px; margin-bottom: 12px; }
    .kpi-card { background: var(--white); border:2px solid var(--frame); border-radius: 12px; text-align: center; padding: 12px; }
    .kpi-title { font-size:.95rem; color:var(--muted); }
    .kpi-value { font-size: 1.5em; font-weight: 800; color: var(--fg); margin-top: 6px; display:flex; align-items:center; justify-content:center; gap:10px; }
    .tri { width:0; height:0; border-left:7px solid transparent; border-right:7px solid transparent; }
    .tri-up   { border-bottom:12px solid var(--accent); }
    .tri-down { border-top:12px solid #dc2626; }

    .charts { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 12px; }
    .chart-box { background: var(--white); border:2px solid var(--frame); border-radius: 12px; padding: 12px; }
    .chart-title { margin:0 0 8px 0; font-weight:700; color: var(--brand); }
    .grid-yn { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:12px; margin-top:10px; }
    canvas { width: 100%; height: 320px; }
    .yn-canvas { height: 240px; }
  </style>
</head>

<body>
  <div class="panel">
    <div class="toolbar">
      <h2>لوحة المؤشرات المالية للبلديات</h2>
      <span id="scopeLabel" class="muted">— عرض جميع البلديات</span>

      <div class="fld">
        <label class="muted">الفئة (اختياري)</label>
        <select id="filterCategory" class="in"></select>
      </div>
      <div class="fld">
        <label class="muted">تحقيق المستهدف</label>
        <select id="filterAchieved" class="in" required>
          <option value="">— يرجى الاختيار —</option>
          <option value="نعم">نعم</option>
          <option value="لا">لا</option>
        </select>
      </div>
      <div class="fld">
        <label class="muted">بحث بالبلدية</label>
        <input id="searchName" class="in" placeholder="أدخل اسم البلدية" />
      </div>

      <button id="resetBtn" class="btn">إظهار الكل</button>
      <button id="clearFilters" class="btn">مسح المرشحات</button>
    </div>

    <div id="viewDiv"></div>

    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-title">إجمالي الإيرادات المستهدفة</div>
        <div id="kpiTarget" class="kpi-value">—</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">إجمالي الإيرادات المحصّلة</div>
        <div id="kpiCollected" class="kpi-value">—</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">نسبة تحقيق الإيرادات (×100)</div>
        <div id="kpiAchPct" class="kpi-value">—</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">متوسط الصرف (×100)</div>
        <div id="kpiAvgSpend" class="kpi-value">—</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">نسبة رضا المواطنين (×100)</div>
        <div id="kpiSatisfaction" class="kpi-value">—</div>
      </div>
    </div>

    <div class="charts">
      <div class="chart-box">
        <h3 class="chart-title">الإيرادات المستهدفة مقابل المحصّلة (ألوان البلديات مطابقة للخريطة)</h3>
        <canvas id="chartRevenue"></canvas>
      </div>
    </div>

    <div class="charts" style="margin-top:10px;">
      <div class="chart-box" style="grid-column: 1 / -1;">
        <h3 class="chart-title">مؤشرات نعم/لا</h3>
        <div class="grid-yn">
          <div><div class="muted">يوجد مطار</div><canvas id="yn_airport" class="yn-canvas"></canvas></div>
          <div><div class="muted">يوجد طريق دولي</div><canvas id="yn_intlroad" class="yn-canvas"></canvas></div>
          <div><div class="muted">يوجد مستشفى</div><canvas id="yn_hospital" class="yn-canvas"></canvas></div>
          <div><div class="muted">يوجد مدينة صناعية</div><canvas id="yn_industrial" class="yn-canvas"></canvas></div>
          <div><div class="muted">يوجد نادي</div><canvas id="yn_club" class="yn-canvas"></canvas></div>
          <div><div class="muted">حققت المستهدف</div><canvas id="yn_achieved" class="yn-canvas"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ArcGIS app -->
  <script>
  require([
    "esri/Map",
    "esri/views/MapView",
    "esri/layers/FeatureLayer",
    "esri/renderers/UniqueValueRenderer"
  ], function (Map, MapView, FeatureLayer, UniqueValueRenderer) {

    const SERVICE_URL = "https://services5.arcgis.com/pbXsNv81cTqt6LrT/arcgis/rest/services/Map/FeatureServer/0";

    const FIELDS = {
      name: "البلدية",
      target: "الإيراد_المستهدف",
      collected: "الإيراد_المحصّل",
      avgSpend: "متوسط_الصرف",     // ×100 للعرض
      achPctField: "نسبة_الإيراد_", // ×100 للعرض والخريطة
      satisfaction: "نسبة_الرضا",   // ×100
      category: "الفئة",
      yn_airport: "يوجد_مطار",
      yn_intlroad: "يوجد_طريق_دولي",
      yn_hospital: "يوجد_مستشفى",
      yn_industrial: "يوجد_مدينة_صناعية",
      yn_club: "يوجد_نادي",
      yn_achieved: "حققت_المستهدف"
    };

    function toNumber(v) {
      if (v == null) return 0;
      let s = String(v).trim();
      const map = {'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9','٫':'.','٬':','};
      s = s.replace(/[٠-٩٫٬]/g, ch => map[ch] ?? ch).replace(/,/g, '');
      const n = Number(s);
      return isNaN(n) ? 0 : n;
    }
    const fmt = (n,d=1)=>isNaN(n)?'—':new Intl.NumberFormat('ar-SA',{maximumFractionDigits:d}).format(n);

    // ألوان فريدة لكل بلدية (خريطة + أعمدة) + إطار أسود 2px للخريطة عبر CSS أعلاه
    const colorMap = {};
    function hslToRgbArray(h, s, l) {
      s = Math.max(0, Math.min(1, s)); l = Math.max(0, Math.min(1, l));
      const c = (1 - Math.abs(2*l - 1)) * s; const hp = h/60; const x = c * (1 - Math.abs(hp % 2 - 1));
      let [r,g,b] = [0,0,0];
      if (0<=hp && hp<1) [r,g,b] = [c,x,0];
      else if (1<=hp && hp<2) [r,g,b]=[x,c,0];
      else if (2<=hp && hp<3) [r,g,b]=[0,c,x];
      else if (3<=hp && hp<4) [r,g,b]=[0,x,c];
      else if (4<=hp && hp<5) [r,g,b]=[x,0,c];
      else if (5<=hp && hp<6) [r,g,b]=[c,0,x];
      const m = l - c/2; return [Math.round((r+m)*255), Math.round((g+m)*255), Math.round((b+m)*255)];
    }
    function genColor(i, n) {
      const h = (i * (360 / Math.max(1,n))) % 360; const [r,g,b]=hslToRgbArray(h, 0.65, 0.55); return `rgb(${r},${g},${b})`;
    }

    const layer = new FeatureLayer({ url: SERVICE_URL, outFields: ["*"], title: "Finance_Data", popupEnabled: false });

    const map = new Map({ basemap: "osm", layers: [layer] });
    const view = new MapView({ container: "viewDiv", map });

    let allRows = []; let filteredRows = []; let selectedName = null; let highlight = null; let layerViewRef = null;
    const $ = (id)=>document.getElementById(id);

    function updateScopeLabel(rows) {
      const label = $("scopeLabel");
      if (selectedName) label.textContent = `— عرض بلدية: ${selectedName} — عدد: ${rows.length}`;
      else label.textContent = `— عرض جميع البلديات (حسب المرشحات) — عدد: ${rows.length}`;
    }

    function setAchTriangle(container, pctVal) {
      container.innerHTML = "";
      const spanVal = document.createElement("span");
      spanVal.textContent = (pctVal == null ? "—" : fmt(pctVal) + "%");
      container.appendChild(spanVal);
      if (pctVal == null) return;
      const tri = document.createElement("span");
      tri.className = "tri " + (pctVal >= 100 ? "tri-up" : "tri-down");
      container.appendChild(tri);
    }

    function sum(rows, field) { return rows.reduce((s,v)=>s + toNumber(v[field]), 0); }

    function updateKPIs(rows) {
      const totalTarget    = sum(rows, FIELDS.target);
      const totalCollected = sum(rows, FIELDS.collected);
      const avgPct100      = (sum(rows, FIELDS.achPctField) / (rows.length || 1)) * 100; // ×100
      const avgSpend100    = (sum(rows, FIELDS.avgSpend)    / (rows.length || 1)) * 100; // ×100
      const avgSatisf100   = (sum(rows, FIELDS.satisfaction)/ (rows.length || 1)) * 100; // ×100

      $("kpiTarget").textContent       = fmt(totalTarget);
      $("kpiCollected").textContent    = fmt(totalCollected);
      setAchTriangle($("kpiAchPct"), isNaN(avgPct100) ? null : avgPct100);
      $("kpiAvgSpend").textContent     = fmt(avgSpend100) + "%";
      $("kpiSatisfaction").textContent = fmt(avgSatisf100) + "%";
    }

    function buildUniqueRenderer(names) {
      const infos = names.map((nm, i) => {
        const c = colorMap[nm] || (colorMap[nm] = genColor(i, names.length));
        return { value: nm, symbol: { type: "simple-fill", color: c, outline: { color: "#000", width: 1 } }, label: nm };
      });
      return new UniqueValueRenderer({ field: FIELDS.name, defaultSymbol: { type: "simple-fill", color: [220,220,220,0.5], outline: { color: "#000", width: 1 } }, uniqueValueInfos: infos });
    }

    function applyFilters() {
      const cat = $("filterCategory").value;
      const ach = $("filterAchieved").value; // مطلوب اختيار نعم/لا أو فراغ (لكن لدينا required على العنصر)
      const q   = ($("searchName").value || "").trim();

      filteredRows = allRows.filter(r => {
        if (cat && r[FIELDS.category] !== cat) return false;
        if (ach !== "" && ((r[FIELDS.yn_achieved] ?? "") !== ach)) return false;
        if (q && !String(r[FIELDS.name] || "").includes(q)) return false;
        return true;
      });

      const rowsForDash = selectedName ? filteredRows.filter(r => r[FIELDS.name] === selectedName) : filteredRows;
      updateKPIs(rowsForDash); updateScopeLabel(rowsForDash);
      window.postMessage({ type: "financeData", data: rowsForDash, fields: FIELDS, colorMap }, "*");
    }

    function populateFilters() {
      const catSelect = $("filterCategory");
      catSelect.innerHTML = '<option value="">— الكل —</option>';
      const cats = [...new Set(allRows.map(r => r[FIELDS.category]).filter(Boolean))].sort();
      cats.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.textContent = c; catSelect.appendChild(opt); });
    }

    function resetSelection() { if (highlight) highlight.remove(); highlight = null; selectedName = null; applyFilters(); }

    // استقبال اختيار اسم من الرسم
    window.addEventListener("message", (e) => {
      const ev = e.data || {}; if (ev.type !== "selectByName" || !ev.name) return; selectedName = ev.name; applyFilters();
      if (layerViewRef) { layerViewRef.queryFeatures({ where: `${FIELDS.name}='${String(ev.name).replace(/'/g,"''")}'` }).then((res)=>{ if (highlight) highlight.remove(); if (res.features.length){ highlight = layerViewRef.highlight(res.features[0]); view.goTo(res.features[0].geometry.extent.expand(1.5)).catch(()=>{}); } }); }
    });

    view.when(async () => {
      await layer.when(); const info = await layer.load(); if (info.fullExtent) await view.goTo(info.fullExtent.expand(1.1));
      const q = await layer.queryFeatures({ where: "1=1", outFields: ["*"], returnGeometry: true });
      allRows = q.features.map(f => f.attributes);

      const allNames = [...new Set(allRows.map(r => r[FIELDS.name]).filter(Boolean))];
      allNames.forEach((nm, i) => { if (!colorMap[nm]) colorMap[nm] = genColor(i, allNames.length); });
      layer.renderer = buildUniqueRenderer(allNames);

      filteredRows = allRows; populateFilters(); applyFilters();

      view.whenLayerView(layer).then((lv) => {
        layerViewRef = lv;
        view.on("click", async (event) => {
          const hit = await view.hitTest(event);
          const g = hit.results.find(r => r.graphic && r.graphic.layer === layer)?.graphic;
          if (!g) { resetSelection(); return; }
          if (highlight) highlight.remove(); highlight = lv.highlight(g);
          selectedName = g.attributes[FIELDS.name] || null; applyFilters();
          const a = g.attributes;
          const pct100 = toNumber(a[FIELDS.achPctField]) * 100;
          const spend100 = toNumber(a[FIELDS.avgSpend]) * 100;
          const satisf100 = toNumber(a[FIELDS.satisfaction]) * 100;
          const msg = `
            <b>${a[FIELDS.name] ?? "—"}</b><br>
            الإيراد المستهدف: ${fmt(toNumber(a[FIELDS.target]))}<br>
            الإيراد المحصّل: ${fmt(toNumber(a[FIELDS.collected]))}<br>
            نسبة تحقيق الإيرادات: ${fmt(pct100)}%<br>
            متوسط الصرف: ${fmt(spend100)}%<br>
            نسبة الرضا: ${fmt(satisf100)}%
          `;
          view.popup.open({ title: "تفاصيل البلدية", content: msg, location: event.mapPoint });
        });

        $("resetBtn").addEventListener("click", resetSelection);
        $("clearFilters").addEventListener("click", () => { $("filterCategory").value = ""; $("filterAchieved").value = ""; $("searchName").value = ""; resetSelection(); });
        $("filterCategory").addEventListener("change", applyFilters);
        $("filterAchieved").addEventListener("change", applyFilters);
        $("searchName").addEventListener("input", () => { clearTimeout(window.__t); window.__t = setTimeout(applyFilters, 250); });
      });
    });
  });
  </script>

  <!-- Charts (ESM, isolated from Dojo) -->
  <script type="module">
    import { Chart, BarController, BarElement, CategoryScale, LinearScale, Legend, Title, Tooltip, ArcElement } from "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/+esm";
    Chart.register(BarController, BarElement, CategoryScale, LinearScale, Legend, Title, Tooltip, ArcElement);

    let chartRevenue; const ynCharts = {};

    function ensureYNChart(id, yes, no) {
      const el = document.getElementById(id);
      const data = { labels: ["نعم", "لا"], datasets: [{ data: [yes, no], backgroundColor: ["#22c55e", "#ef4444"], borderColor:["#000","#000"], borderWidth:2 }] };
      const opt = { responsive: true, plugins: { legend: { position: "bottom" } }, cutout: "55%" };
      if (!ynCharts[id]) ynCharts[id] = new Chart(el, { type: "doughnut", data, options: opt });
      else { ynCharts[id].data = data; ynCharts[id].options = opt; ynCharts[id].update(); }
    }

    function normalizeYN(v) {
      const s = (v ?? "").toString().trim().toLowerCase();
      if (s === "نعم" || s === "yes" || s === "y" || s === "true" || s === "1") return "yes";
      if (s === "لا"  || s === "no"  || s === "n" || s === "false"|| s === "0") return "no";
      return "no";
    }

    function attachBarClick(chart, labels) {
      chart.canvas.onclick = (evt) => {
        const points = chart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
        if (!points.length) return; const idx = points[0].index; const name = labels[idx];
        window.postMessage({ type: "selectByName", name }, "*");
      };
    }

    function renderCharts(rows, fields, colorMap) {
      const names     = rows.map(r => r[fields.name] ?? "—");
      const targets   = rows.map(r => Number(String(r[fields.target]).replace(/,/g,'')) || 0);
      const collected = rows.map(r => Number(String(r[fields.collected]).replace(/,/g,'')) || 0);

      // ترتيب حسب المستهدف (أعلى 12)
      const indices = targets.map((v,i)=>({i,v})).sort((a,b)=>b.v-a.v).slice(0, Math.max(1, Math.min(12, targets.length))).map(o=>o.i);
      const labels = indices.map(i=>names[i]);
      const targetData = indices.map(i=>targets[i]);
      const collectedData = indices.map(i=>collected[i]);
      const barColors = labels.map(nm => colorMap[nm] || "#0ea5e9");

      const data1 = {
        labels,
        datasets: [
          { label: "المستهدف", data: targetData, backgroundColor: "#9ca3af", borderColor: "#000", borderWidth: 2, categoryPercentage:0.6, barPercentage:0.9 },
          { label: "المحصّل",  data: collectedData, backgroundColor: barColors,   borderColor: "#000", borderWidth: 2, categoryPercentage:0.6, barPercentage:0.9 }
        ]
      };
      const opt1 = {
        responsive:true,
        plugins:{ legend:{position:"bottom"}, title:{display:true, text:"الإيرادات المستهدفة مقابل المحصّلة"} },
        scales:{ y:{ beginAtZero:true } }
      };
      if (!chartRevenue) { chartRevenue = new Chart(document.getElementById("chartRevenue"), { type:"bar", data:data1, options:opt1 }); attachBarClick(chartRevenue, labels); }
      else { chartRevenue.data = data1; chartRevenue.update(); attachBarClick(chartRevenue, labels); }

      // YES/NO doughnuts
      const ynSets = [
        { id: "yn_airport",    field: fields.yn_airport },
        { id: "yn_intlroad",   field: fields.yn_intlroad },
        { id: "yn_hospital",   field: fields.yn_hospital },
        { id: "yn_industrial", field: fields.yn_industrial },
        { id: "yn_club",       field: fields.yn_club },
        { id: "yn_achieved",   field: fields.yn_achieved }
      ];
      for (const {id, field} of ynSets) {
        let yes = 0, no = 0; for (const r of rows) (normalizeYN(r[field]) === "yes") ? yes++ : no++;
        ensureYNChart(id, yes, no);
      }
    }

    window.addEventListener("message", (e) => {
      const ev = e.data || {}; if (ev.type !== "financeData") return; renderCharts(ev.data, ev.fields, ev.colorMap || {});
    });
  </script>
</body>
</html>
