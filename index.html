<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة المؤشرات المالية للبلديات</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>

  <script>window.__amd_define_backup__=window.define; window.define=undefined;</script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>window.define=window.__amd_define_backup__; window.__amd_define_backup__=undefined;</script>

  <style>
    :root{
      --frame:#000; --navy:#0a4b78; --green:#16a34a; --red:#ef4444;
      --fs:22px; --fs-title:28px; --fs-h1:34px; --fs-small:18px;
    }
    html,body{margin:0;padding:0;height:100%;font-family:"Cairo",Arial,sans-serif;background:#fff;color:#0f172a;}
    body.has-bg{background-size:cover;background-attachment:fixed;background-position:center;background-repeat:no-repeat;}

    /* Sticky title bar with logos */
    .titlebar{
  position:sticky;
  top:0;
  z-index:100;
  display:grid;
  grid-template-columns:100px 1fr 100px;
  align-items:center;
  gap:10px;
  background:rgba(255,255,255,0.5);  /* 50% transparent white */
  border-bottom:3px solid var(--frame);
  padding:10px 14px;
  box-shadow:0 3px 10px rgba(0,0,0,0.15);
  backdrop-filter:blur(10px) saturate(140%);
  -webkit-backdrop-filter:blur(10px) saturate(140%);
  transition:background 0.3s ease;
}
    #logoLeft,#logoRight{
      width:80px;height:80px;object-fit:contain;background:#fff;
      border:3px solid var(--frame);border-radius:12px;padding:4px;
    }
    .titlebar h1{
      text-align:center;margin:0;font-size:var(--fs-h1);color:var(--navy);font-weight:900;
    }

    /* KPI section with watermark */
    .kpis-wrap{position:relative;margin:12px;border:3px solid var(--frame);border-radius:14px;
      background:rgba(255,255,255,0.9);backdrop-filter:blur(2px);overflow:hidden;box-shadow:0 6px 16px rgba(0,0,0,0.12);}
    .kpis-watermark{position:absolute;inset:0;background-position:center;background-repeat:no-repeat;background-size:520px auto;opacity:.12;pointer-events:none;}
    .kpis{position:relative;z-index:1;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;padding:14px;}
    .kpi{background:#fff;border:3px solid var(--frame);border-radius:14px;padding:16px;text-align:center;}
    .kpi .label{font-size:20px;color:var(--navy);font-weight:900;}
    .kpi .value{font-size:34px;font-weight:900;color:var(--green);display:flex;align-items:center;justify-content:center;gap:10px;}
    .tri{width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;}
    .tri-up{border-bottom:16px solid var(--green);}
    .tri-down{border-top:16px solid var(--red);}
    .fade-in{animation:fadeIn .5s ease both;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:none;}}
    .bounce{animation:bounce .45s ease;}
    @keyframes bounce{0%{transform:translateY(0);}35%{transform:translateY(-4px);}100%{transform:translateY(0);}}

    /* Layout */
    .grid{display:grid;grid-template-columns:1fr 420px 380px;gap:14px;padding:14px;}
    .card{border:3px solid var(--frame);border-radius:14px;padding:14px;}
    .title{font-weight:900;color:var(--navy);font-size:var(--fs-title);margin-bottom:10px;text-align:center;}
    .glass-strong{background:rgba(255,255,255,0.85);backdrop-filter:blur(6px);box-shadow:0 6px 16px rgba(0,0,0,0.15);}
    .glass{background:rgba(255,255,255,0.5);backdrop-filter:blur(6px);box-shadow:0 6px 16px rgba(0,0,0,0.12);}
    #viewDiv{min-height:60vh;height:60vh;border:3px solid var(--frame);border-radius:12px;}
    #chartPie{width:100%!important;height:420px!important;}
    #pieCenter{position:absolute;left:0;right:0;text-align:center;font-weight:900;font-size:32px;color:var(--green);top:52%;transform:translateY(-50%);pointer-events:none;opacity:0;transition:opacity .4s ease;}
    #pieWrap{position:relative;}
    .legend-scope{text-align:center;color:var(--navy);font-weight:800;margin-top:6px;}
    #filters label{font-weight:900;color:var(--navy);display:block;margin-bottom:6px;}
    #filters select{width:100%;padding:10px;font-size:20px;border:3px solid var(--frame);border-radius:12px;background:#fff;}
    .btn{font-size:20px;padding:10px;border:3px solid var(--frame);border-radius:12px;background:#fff;cursor:pointer;}
    .btn:hover{background:#dbeafe;}
    @media(max-width:1300px){.grid{grid-template-columns:1fr;}#viewDiv{height:56vh;min-height:56vh;}}
  </style>
</head>
<body>
  <!-- Titlebar -->
  <div class="titlebar">
    <img id="logoLeft" alt="GCLA" />
    <h1>لوحة المؤشرات المالية للبلديات</h1>
    <img id="logoRight" alt="Riyadh Municipality" />
  </div>

  <!-- KPI Section -->
  <section class="kpis-wrap">
    <div id="kpisWM" class="kpis-watermark"></div>
    <div class="kpis">
      <div class="kpi fade-in"><div class="label">إجمالي الإيرادات المستهدفة</div><div id="kpiTarget" class="value">—</div></div>
      <div class="kpi fade-in"><div class="label">إجمالي الإيرادات المحصّلة</div><div id="kpiCollected" class="value">—</div></div>
      <div class="kpi fade-in"><div class="label">نسبة تحقيق الإيرادات</div><div id="kpiAchPct" class="value">—</div></div>
      <div class="kpi fade-in"><div class="label">متوسط الصرف</div><div id="kpiAvgSpend" class="value">—</div></div>
      <div class="kpi fade-in"><div class="label">نسبة الرضا</div><div id="kpiSatisfaction" class="value">—</div></div>
    </div>
  </section>

  <main class="grid">
    <section id="mapCard" class="card glass-strong">
      <div class="title">الخريطة</div>
      <div id="viewDiv"></div>
    </section>

    <section id="pieCard" class="card glass-strong">
      <div class="title">مجموع المستهدفة و مجموع المحصّلة</div>
      <div id="pieWrap">
        <canvas id="chartPie"></canvas>
        <div id="pieCenter"></div>
      </div>
      <div id="pieScope" class="legend-scope">النطاق: كل البلديات</div>
    </section>

    <aside id="filters" class="card glass">
      <div class="title">المرشحات</div>
      <div><label for="filterCategory">الفئة</label><select id="filterCategory"></select></div>
      <div><label for="filterAchieved">تحقيق المستهدف</label><select id="filterAchieved"><option value="">— الكل —</option><option value="نعم">نعم</option><option value="لا">لا</option></select></div>
      <div><label for="filterMun">البلدية</label><select id="filterMun"></select></div>
      <div style="margin-top:12px;display:flex;gap:10px;"><button id="resetBtn" class="btn">إظهار الكل</button><button id="clearBtn" class="btn">مسح المرشحات</button></div>
    </aside>
  </main>

  <footer style="border-top:3px solid var(--frame);padding:12px;text-align:center;background:#fff;font-size:var(--fs-small);color:var(--navy);">
    <strong>Powered by : Eng. Mohaned</strong>
  </footer>

<script>
/* Paths to your local images */
const LOGO_RIYADH="file:///D:/Work/Eng_Yazeed/Data/Logo_Amana.png";
const LOGO_GCLA="file:///D:/Work/Eng_Yazeed/Data/gcla.jpg";
const BG_TEXTURE="file:///D:/Work/Eng_Yazeed/Data/background.png";

const SERVICE_URL="https://services5.arcgis.com/pbXsNv81cTqt6LrT/arcgis/rest/services/Map/FeatureServer/0";
const FIELDS={name:'البلدية',target:'مجموع_المستهدفة',collected:'مجموع_المحصلة',achPct:'نسبة_الإيراد_',avgSpend:'متوسط_الصرف',satisfaction:'نسبة_الرضا',category:'الفئة',achieved:'حققت_المستهدف'};
const $=id=>document.getElementById(id);
const fmt=(n,d=1)=>isNaN(n)?'—':new Intl.NumberFormat('ar-SA',{maximumFractionDigits:d}).format(n);
const toNumber=v=>{if(v==null)return 0;return Number(String(v).replace(/[^\d.-]/g,''))||0;};

let all=[],filtered=[],layer,view,pieChart=null,selectedName=null;

(function initBranding(){
  document.body.classList.add('has-bg');
  document.body.style.backgroundImage=`url('${BG_TEXTURE}')`;
  $("logoLeft").src=LOGO_GCLA; $("logoRight").src=LOGO_RIYADH;
  $("kpisWM").style.backgroundImage=`url('${LOGO_RIYADH}')`;
})();

function populateFilters(){
  const cats=[...new Set(all.map(r=>r[FIELDS.category]).filter(Boolean))];
  const el=$('filterCategory'); el.innerHTML='<option value=\"\">— الكل —</option>';
  cats.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;el.appendChild(o);});
  const muns=[...new Set(all.map(r=>r[FIELDS.name]).filter(Boolean))];
  const el2=$('filterMun'); el2.innerHTML='<option value=\"\">— الكل —</option>';
  muns.forEach(m=>{const o=document.createElement('option');o.value=m;o.textContent=m;el2.appendChild(o);});
}
function applyFilters(){
  const cat=$('filterCategory').value,ach=$('filterAchieved').value,mun=$('filterMun').value;
  filtered=all.filter(r=>{
    if(cat&&r[FIELDS.category]!==cat)return false;
    if(ach&&(r[FIELDS.achieved]||'')!==ach)return false;
    if(mun&&r[FIELDS.name]!==mun)return false;
    return true;
  });
  selectedName=mun||null;updateDashboard();
}
function resetFilters(){$('filterCategory').value='';$('filterAchieved').value='';$('filterMun').value='';selectedName=null;filtered=all;updateDashboard();}

function animateCount(el,to,suffix=''){const from=0;const dur=550;const t0=performance.now();const step=t=>{const p=Math.min(1,(t-t0)/dur);const val=from+(to-from)*p;el.textContent=fmt(val,(Math.abs(to)>=100?0:1))+suffix;if(p<1)requestAnimationFrame(step);};requestAnimationFrame(step);}
function setTriangle(el,pct){el.innerHTML='';const v=document.createElement('span');v.id='__val';el.appendChild(v);const tri=document.createElement('span');tri.className='tri';el.appendChild(tri);animateCount(v,pct,'%');if(pct>=75){tri.classList.add('tri-up','bounce');v.style.color='var(--green)';}else{tri.classList.add('tri-down','bounce');v.style.color='var(--red)';}}
function updateDashboard(){
  const rows=(filtered.length?filtered:all);
  const sum=f=>rows.reduce((s,r)=>s+toNumber(r[f]),0);
  const avg=f=>rows.length?rows.reduce((s,r)=>s+toNumber(r[f]),0)/rows.length:0;
  const t=sum(FIELDS.target),c=sum(FIELDS.collected),ach=avg(FIELDS.achPct)*100,sp=avg(FIELDS.avgSpend)*100,sa=avg(FIELDS.satisfaction)*100;
  animateCount($("kpiTarget"),t);animateCount($("kpiCollected"),c);setTriangle($("kpiAchPct"),ach);
  animateCount($("kpiAvgSpend"),sp,'%');animateCount($("kpiSatisfaction"),sa,'%');
  renderPie(t,c,ach);
  $("pieScope").textContent=selectedName?`النطاق: ${selectedName}`:'النطاق: كل البلديات';
}
function renderPie(t,c,ach){
  const data={labels:['المحصّلة','المستهدفة'],datasets:[{data:[c,t],backgroundColor:['#16a34a','#0a4b78'],borderColor:'#000',borderWidth:3}]};
  if(pieChart)pieChart.destroy();
  pieChart=new Chart($("chartPie"),{type:'doughnut',data,options:{plugins:{legend:{position:'bottom'}},cutout:'68%',responsive:true,maintainAspectRatio:false}});
  const center=$("pieCenter");center.style.opacity=0;center.textContent=fmt(ach,1)+'%';requestAnimationFrame(()=>center.style.opacity=1);
}
function hsl(h,s,l){s=Math.max(0,Math.min(1,s));l=Math.max(0,Math.min(1,l));const c=(1-Math.abs(2*l-1))*s,hp=h/60,x=c*(1-Math.abs(hp%2-1));let[r,g,b]=[0,0,0];
  if(0<=hp&&hp<1)[r,g,b]=[c,x,0];else if(1<=hp&&hp<2)[r,g,b]=[x,c,0];else if(2<=hp&&hp<3)[r,g,b]=[0,c,x];
  else if(3<=hp&&hp<4)[r,g,b]=[0,x,c];else if(4<=hp&&hp<5)[r,g,b]=[x,0,c];else[r,g,b]=[c,0,x];
  const m=l-c/2;r=Math.round((r+m)*255);g=Math.round((g+m)*255);b=Math.round((b+m)*255);return`rgba(${r},${g},${b},0.55)`;}

require(["esri/Map","esri/views/MapView","esri/layers/FeatureLayer","esri/renderers/UniqueValueRenderer","esri/layers/support/LabelClass"],(Map,MapView,FeatureLayer,UniqueValueRenderer,LabelClass)=>{
  const layer=new FeatureLayer({url:SERVICE_URL,outFields:["*"],popupEnabled:false});
  layer.labelsVisible=true;
  layer.labelingInfo=[new LabelClass({labelExpressionInfo:{expression:`$feature.${FIELDS.name}`},symbol:{type:"text",color:"#000",haloColor:"#fff",haloSize:1.5,font:{size:14,family:"Cairo, Arial"}}})];
  const map=new Map({basemap:"osm",layers:[layer]});
  const view=new MapView({container:"viewDiv",map});
  view.highlightOptions={color:[14,165,233,1.0],haloOpacity:0.9,fillOpacity:0.15};
  view.when(async()=>{await layer.when();const q=await layer.queryFeatures({where:"1=1",outFields:["*"],returnGeometry:true});
    const feats=q.features;all=feats.map(f=>f.attributes);filtered=all.slice();
    const names=[...new Set(all.map(r=>r[FIELDS.name]).filter(Boolean))];
    layer.renderer=new UniqueValueRenderer({field:FIELDS.name,defaultSymbol:{type:'simple-fill',color:'rgba(255,255,255,0.8)',outline:{color:'#000',width:1.2}},uniqueValueInfos:names.map((nm,i)=>({value:nm,label:nm,symbol:{type:'simple-fill',color:hsl(i*(360/Math.max(1,names.length)),0.45,0.55),outline:{color:'#000',width:1.2}}}))});
    if(layer.fullExtent)view.goTo(layer.fullExtent.expand(1.05)).catch(()=>{});
    populateFilters();updateDashboard();
    $("filterCategory").onchange=applyFilters;$("filterAchieved").onchange=applyFilters;$("filterMun").onchange=applyFilters;
    $("resetBtn").onclick=()=>{resetFilters();};$("clearBtn").onclick=resetFilters;
    let selectionHighlight=null,hoverHighlight=null,lastHoverId=null,hoverTimer=null;
    view.on("click",async(evt)=>{const hit=await view.hitTest(evt);const g=hit.results.find(r=>r.graphic&&r.graphic.layer===layer)?.graphic;
      if(selectionHighlight){selectionHighlight.remove();selectionHighlight=null;}
      if(!g){selectedName=null;$("filterMun").value="";applyFilters();return;}
      const lv=await view.whenLayerView(layer);selectionHighlight=lv.highlight(g);
      selectedName=g.attributes[FIELDS.name]||null;$("filterMun").value=selectedName||"";applyFilters();
      if(g.geometry&&g.geometry.extent)view.goTo(g.geometry.extent.expand(1.35)).catch(()=>{});});
    view.on("pointer-move",(evt)=>{if(hoverTimer)return;hoverTimer=setTimeout(async()=>{hoverTimer=null;const hit=await view.hitTest(evt);
      const g=hit.results.find(r=>r.graphic&&r.graphic.layer===layer)?.graphic;const lv=await view.whenLayerView(layer);
      if(!g){if(hoverHighlight){hoverHighlight.remove();hoverHighlight=null;lastHoverId=null;}return;}
      const oid=g.getObjectId?g.getObjectId():g.attributes.OBJECTID;if(lastHoverId===oid)return;
      if(hoverHighlight){hoverHighlight.remove();hoverHighlight=null;}hoverHighlight=lv.highlight(g);lastHoverId=oid;},100);});
  });
});
</script>
</body>
</html>
