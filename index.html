<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة المؤشرات المالية للبلديات</title>

  <!-- Font -->
  <style>
  @font-face {
    font-family: 'Bahij TheSansArabic';
    src: local('Bahij TheSansArabic'),
         url('D:/Work/Eng_Yazeed/Data/BahijTheSansArabic-Bold.woff2') format('woff2');
    font-weight: 700;
    font-style: normal;
  }
  html, body {
    font-family: 'Bahij TheSansArabic', 'Cairo', Arial, sans-serif;
    font-weight: 700;
    margin: 0;
    padding: 0;
    height: 100vh;
    overflow: hidden;
    background: #fff;
    color: #fff; /* default white text */
  }
  </style>

  <!-- ArcGIS -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>

  <!-- Chart.js -->
  <script>window.__amd_define_backup__=window.define;window.define=undefined;</script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>window.define=window.__amd_define_backup__;window.__amd_define_backup__=undefined;</script>

  <style>
    :root {
      --frame:#000; --navy:#0a4b78; --green:#16a34a; --red:#ef4444;
    }

    body.has-bg {
      background-image: url("https://raw.githubusercontent.com/SDMohaned/RiyadhKBI/main/background.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    /* Transparent KPI Section */
    .kpis-wrap {
      margin: 10px;
      border: 3px solid var(--frame);
      border-radius: 14px;
      background: rgba(255,255,255,0.4);  /* 40% transparent */
      backdrop-filter: blur(8px);
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(230px,1fr));
      gap: 10px;
      padding: 14px;
    }

    .kpi {
      background: rgba(255,255,255,0.9);
      border: 3px solid var(--frame);
      border-radius: 14px;
      padding: 10px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    .label { color: var(--navy); font-size: 18px; font-weight: 900; }
    .value { font-size: 28px; font-weight: 900; color: var(--green); }

    /* Layout */
    .grid {
      display: grid;
      grid-template-columns: 1.8fr 0.6fr;
      gap: 12px;
      padding: 12px;
      height: calc(100vh - 250px);
    }

    .card {
      border: 3px solid var(--frame);
      border-radius: 14px;
      padding: 12px;
      background: rgba(255,255,255,0.4);
      backdrop-filter: blur(8px);
      color: #fff; /* white text for all card content */
    }

    .title {
      text-align: center;
      font-weight: 900;
      color: #fff; /* white titles */
      font-size: 22px;
      margin-bottom: 6px;
    }

    /* Map */
    #viewDiv {
      width: 100%;
      height: 100%;
      border: 3px solid var(--frame);
      border-radius: 12px;
      background: #fff;
    }

    /* Filters main panel */
    #filters {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Sub-panels inside filters */
    .sub-panel {
      border: 3px solid var(--frame);
      border-radius: 14px;
      padding: 10px;
      background: rgba(255,255,255,0.4);
      backdrop-filter: blur(8px);
      color: #fff;
    }

    .sub-panel label {
      color: #fff;
      font-weight: 900;
      font-size: 18px;
      display: block;
      margin-top: 6px;
    }

    .sub-panel select {
      width: 100%;
      padding: 8px;
      font-size: 18px;
      border: 3px solid var(--frame);
      border-radius: 12px;
      background: #fff;
      color: #000; /* dropdown text black for readability */
      margin-bottom: 8px;
    }

    .btn {
      padding: 8px;
      font-size: 18px;
      border: 3px solid var(--frame);
      border-radius: 12px;
      background: #fff;
      color: #000;
      cursor: pointer;
      font-weight: 700;
    }
    .btn:hover { background: #dbeafe; }

    /* Pie Chart */
    #chartPie {
      width: 100%;
      max-width: 260px;
      aspect-ratio: 1 / 1;
      display: block;
      margin: 14px auto;
      border: 3px solid var(--frame);
      border-radius: 14px;
      padding: 8px;
      background: rgba(255,255,255,0.4);
      backdrop-filter: blur(6px);
    }

    .legend-scope {
      text-align: center;
      color: #fff;
      font-weight: 800;
      margin-top: 6px;
    }

    footer {
      text-align: center;
      border-top: 3px solid var(--frame);
      padding: 10px;
      color: #fff;
    }
  </style>
</head>

<body class="has-bg">
  <section class="kpis-wrap">
    <div class="kpi"><div class="label">إجمالي الإيرادات المستهدفة</div><div id="kpiTarget" class="value">—</div></div>
    <div class="kpi"><div class="label">إجمالي الإيرادات المحصّلة</div><div id="kpiCollected" class="value">—</div></div>
    <div class="kpi"><div class="label">نسبة تحقيق الإيرادات</div><div id="kpiAchPct" class="value">—</div></div>
    <div class="kpi"><div class="label">متوسط الصرف</div><div id="kpiAvgSpend" class="value">—</div></div>
    <div class="kpi"><div class="label">نسبة الرضا</div><div id="kpiSatisfaction" class="value">—</div></div>
  </section>

  <main class="grid">
    <section id="mapCard" class="card">
      <div class="title">الخريطة</div>
      <div id="viewDiv"></div>
    </section>

    <!-- Right side panels -->
    <aside id="filters">
      <div class="sub-panel">
        <div class="title">المرشحات</div>
        <label>الفئة</label><select id="filterCategory"></select>
        <label>تحقيق المستهدف</label>
        <select id="filterAchieved"><option value="">— الكل —</option><option value="نعم">نعم</option><option value="لا">لا</option></select>
        <label>البلدية</label><select id="filterMun"></select>
        <div style="display:flex;gap:6px;margin:8px 0;">
          <button class="btn" id="resetBtn">إظهار الكل</button>
          <button class="btn" id="clearBtn">مسح</button>
        </div>
      </div>

      <div class="sub-panel">
        <div class="title">مجموع المستهدفة و المحصّلة</div>
        <canvas id="chartPie"></canvas>
        <div id="pieScope" class="legend-scope">النطاق: كل البلديات</div>
      </div>

      <div class="sub-panel">
        <div class="title">— مخصص للتطوير لاحقًا —</div>
        <p style="text-align:center;color:#ddd;font-size:16px;">(سيضاف محتوى إضافي في الإصدارات القادمة)</p>
      </div>
    </aside>
  </main>

  <footer><strong>Powered by: Eng. Mohaned</strong></footer>

  <!-- JavaScript -->
  <script>
  const SERVICE_URL="https://services5.arcgis.com/pbXsNv81cTqt6LrT/arcgis/rest/services/Map/FeatureServer/0";
  const FIELDS={name:'البلدية',target:'مجموع_المستهدفة',collected:'مجموع_المحصلة',achPct:'نسبة_الإيراد_',avgSpend:'متوسط_الصرف',satisfaction:'نسبة_الرضا',category:'الفئة',achieved:'حققت_المستهدف'};

  const $=id=>document.getElementById(id);
  const fmt=(n,d=1)=>isNaN(n)?'—':new Intl.NumberFormat('ar-SA',{maximumFractionDigits:d}).format(n);
  const toNumber=v=>{
    if(v==null)return 0;
    const map={'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9','٫':'.','٬':','};
    let s=String(v).replace(/[٠-٩٫٬]/g,ch=>map[ch]||ch).replace(/,/g,'');
    return Number(s)||0;
  };

  let all=[],filtered=[],selectedName=null,pieChart=null,layer,view,highlightHandle=null;

  const renderPie=(t,c,ach)=>{
    if(pieChart) pieChart.destroy();
    const data={labels:['الإيراد المحصّل','الإيراد المستهدف'],
      datasets:[{data:[c,t],backgroundColor:['#16a34a','#0a4b78'],borderColor:'#000',borderWidth:3}]};
    pieChart=new Chart($("chartPie"),{
      type:'doughnut',
      data,
      options:{
        responsive:true,
        maintainAspectRatio:true,
        cutout:'68%',
        plugins:{
          legend:{
            display:true,
            position:'bottom',
            labels:{color:'#fff',font:{family:'Bahij TheSansArabic',size:14,weight:'bold'}}
          },
          tooltip:{callbacks:{label:ctx=>`${ctx.label}: ${fmt(ctx.parsed,0)}`}}
        }
      }
    });
  };

  function updateKPIs(rows){
    const sum=f=>rows.reduce((s,r)=>s+toNumber(r[f]),0);
    const avg=f=>rows.length?rows.reduce((s,r)=>s+toNumber(r[f]),0)/rows.length:0;
    const totalT=sum(FIELDS.target), totalC=sum(FIELDS.collected);
    const ach=avg(FIELDS.achPct)*100, spend=avg(FIELDS.avgSpend)*100, sat=avg(FIELDS.satisfaction)*100;
    $("kpiTarget").textContent=fmt(totalT);
    $("kpiCollected").textContent=fmt(totalC);
    $("kpiAchPct").textContent=fmt(ach,1)+'%';
    $("kpiAvgSpend").textContent=fmt(spend,1)+'%';
    $("kpiSatisfaction").textContent=fmt(sat,1)+'%';
    renderPie(totalT,totalC,ach);
  }

  async function zoomToSelection(val){
    if(!val || !layer || !view) return;
    const q=await layer.queryFeatures({where:`${FIELDS.name}='${val}'`,returnGeometry:true});
    if(q.features.length && q.features[0].geometry){
      view.goTo(q.features[0].geometry.extent.expand(1.5)).catch(()=>{});
    }
  }

  function applyFilters(){
    const cat=$("filterCategory").value,ach=$("filterAchieved").value,mun=$("filterMun").value;
    filtered=all.filter(r=>{
      if(cat&&r[FIELDS.category]!==cat)return false;
      if(ach&&(r[FIELDS.achieved]||'')!==ach)return false;
      if(mun&&r[FIELDS.name]!==mun)return false;
      return true;
    });
    updateKPIs(filtered.length?filtered:all);
    if(mun) zoomToSelection(mun);
  }

  function populateFilters(){
    const cats=[...new Set(all.map(r=>r[FIELDS.category]).filter(Boolean))];
    $("filterCategory").innerHTML='<option value="">— الكل —</option>'+cats.map(c=>`<option>${c}</option>`).join('');
    const muns=[...new Set(all.map(r=>r[FIELDS.name]).filter(Boolean))];
    $("filterMun").innerHTML='<option value="">— الكل —</option>'+muns.map(c=>`<option>${c}</option>`).join('');
  }

  function hsl(h,s,l){
    s=Math.max(0,Math.min(1,s));l=Math.max(0,Math.min(1,l));
    const c=(1-Math.abs(2*l-1))*s,hp=h/60,x=c*(1-Math.abs(hp%2-1));let[r,g,b]=[0,0,0];
    if(0<=hp&&hp<1)[r,g,b]=[c,x,0];else if(1<=hp&&hp<2)[r,g,b]=[x,c,0];
    else if(2<=hp&&hp<3)[r,g,b]=[0,c,x];else if(3<=hp&&hp<4)[r,g,b]=[0,x,c];
    else if(4<=hp&&hp<5)[r,g,b]=[x,0,c];else[r,g,b]=[c,0,x];
    const m=l-c/2;r=Math.round((r+m)*255);g=Math.round((g+m)*255);b=Math.round((b+m)*255);
    return`rgba(${r},${g},${b},0.55)`;
  }

  require(["esri/Map","esri/views/MapView","esri/layers/FeatureLayer","esri/renderers/UniqueValueRenderer","esri/layers/support/LabelClass"],
  (Map,MapView,FeatureLayer,UniqueValueRenderer,LabelClass)=>{
    layer=new FeatureLayer({url:SERVICE_URL,outFields:["*"],popupEnabled:false});
    layer.labelsVisible=true;
    layer.labelingInfo=[new LabelClass({labelExpressionInfo:{expression:`$feature.${FIELDS.name}`},
      symbol:{type:"text",color:"#000",haloColor:"#fff",haloSize:1.5,font:{size:14,family:"Bahij TheSansArabic, Arial"}}})];
    const map=new Map({basemap:"topo-vector",layers:[layer]});
    view=new MapView({container:"viewDiv",map});

    view.when(async()=>{
      await layer.when();
      const q=await layer.queryFeatures({where:"1=1",outFields:["*"],returnGeometry:true});
      all=q.features.map(f=>f.attributes);
      populateFilters();
      filtered=all.slice();
      updateKPIs(all);

      const names=[...new Set(all.map(r=>r[FIELDS.name]).filter(Boolean))];
      layer.renderer=new UniqueValueRenderer({
        field:FIELDS.name,
        defaultSymbol:{type:"simple-fill",color:"rgba(230,230,230,0.6)",outline:{color:"#000",width:1}},
        uniqueValueInfos:names.map((nm,i)=>({value:nm,label:nm,symbol:{type:"simple-fill",color:hsl(i*(360/names.length),0.5,0.6),outline:{color:"#000",width:1}}}))
      });

      if(layer.fullExtent) view.goTo(layer.fullExtent.expand(1.1));

      const lv=await view.whenLayerView(layer);

      view.on("click", async evt=>{
        const hit=await view.hitTest(evt);
        const g=hit.results.find(r=>r.graphic&&r.graphic.layer===layer)?.graphic;
        if(!g){selectedName=null;if(highlightHandle){highlightHandle.remove();highlightHandle=null;}applyFilters();return;}
        if(highlightHandle)highlightHandle.remove();
        highlightHandle=lv.highlight(g);
        selectedName=g.attributes[FIELDS.name];
        $("filterMun").value=selectedName;
        applyFilters();
        if(g.geometry?.extent)view.goTo(g.geometry.extent.expand(1.3)).catch(()=>{});
      });

      $("filterCategory").onchange=applyFilters;
      $("filterAchieved").onchange=applyFilters;
      $("filterMun").onchange=applyFilters;
      $("resetBtn").onclick=()=>{selectedName=null;filtered=all.slice();$("filterCategory").value="";$("filterAchieved").value="";$("filterMun").value="";updateKPIs(all);view.goTo(layer.fullExtent.expand(1.1));};
      $("clearBtn").onclick=()=>{filtered=all.slice();updateKPIs(all);view.goTo(layer.fullExtent.expand(1.1));};
    });
  });
  </script>
</body>
</html>
