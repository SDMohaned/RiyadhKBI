<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة المؤشرات المالية للبلديات</title>

  <!-- ArcGIS API (AMD) -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>

  <!-- Shield Dojo while loading Chart.js (prevents multipleDefine) -->
  <script>window.__amd_define_backup__ = window.define; window.define = undefined;</script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>window.define = window.__amd_define_backup__; window.__amd_define_backup__ = undefined;</script>

  <style>
    :root{
      --bg:#ffffff; --panel:#ffffff; --frame:#000; --text:#0f172a;
      --ok:#22c55e; --no:#ef4444; --grey:#9ca3af; --brand:#0ea5e9;
      --fs:22px; --fs-title:28px; --fs-h1:34px; --fs-small:18px;
    }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text);
                 font-family:"Cairo", Arial, sans-serif; font-size:var(--fs); height:100%; }

    /* Fancy but clean */
    .shadow { box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .chip   { background:#e0f2fe; color:#0369a1; padding:4px 10px; border-radius:999px; border:2px solid #0284c7; }

    /* Shell */
    .shell{ min-height:100vh; display:grid; grid-template-rows:auto auto 1fr auto; }

    header{ padding:16px 20px; border-bottom:3px solid var(--frame);
            background:#e0f2fe; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    header h1{ margin:0; font-size:var(--fs-h1); color:#000; letter-spacing:.2px; }
    #scope{ font-size:var(--fs-small); color:#000; }

    /* KPIs row */
    .kpis{
      display:grid; grid-template-columns: repeat(5, minmax(240px,1fr)); gap:14px;
      padding:14px 14px 0 14px;
    }
    .kpi{ background:#ffffff; border:3px solid var(--frame); border-radius:14px; padding:14px; text-align:center; }
    .kpi .label{ color:#111; font-weight:800; font-size:20px; }
    .kpi .value{ font-size:32px; font-weight:900; margin-top:8px; color:var(--brand);
                 display:flex; align-items:center; justify-content:center; gap:12px; }
    .tri{ width:0; height:0; border-left:10px solid transparent; border-right:10px solid transparent; }
    .tri-up{ border-bottom:16px solid var(--ok); }
    .tri-down{ border-top:16px solid #dc2626; }

    /* Main grid: left pies / center map / right filters; then bottom chart full width */
    .grid{
      display:grid;
      grid-template-columns: 470px 1fr 380px;   /* wider left to host 3x2 pies */
      grid-template-rows: 1fr auto;
      gap:14px;
      padding:14px;
      min-height:0;
    }
    .card{ background:var(--panel); border:3px solid var(--frame); border-radius:14px; padding:14px; }
    .title{ margin:0 0 10px 0; font-weight:900; color:#000; font-size:var(--fs-title); display:flex; align-items:center; gap:10px; }

    /* Map center (dominant) */
    #mapCard{ grid-column:2; grid-row:1; display:flex; flex-direction:column; }
    #viewDiv{ flex:1 1 auto; min-height:64vh; border:3px solid var(--frame); border-radius:12px; background:#fff; }

    /* LEFT pies: GRID (2 rows x 3 columns), smaller size, perfect circles */
    #pies{ grid-column:1; grid-row:1; display:flex; flex-direction:column; gap:12px; }
    .pies-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      grid-auto-rows: 1fr;
      gap:12px;
    }
    .pie-card{ background:#fff; border:3px solid var(--frame); border-radius:12px; padding:8px; }
    .pie-title{ text-align:center; font-weight:900; margin-bottom:6px; font-size:18px; }
    .pie-wrap{ width:100%; aspect-ratio:1/1; }
    .pie-canvas{ width:100% !important; height:100% !important; display:block; }
    .legend-mini{ text-align:center; font-size:16px; color:#334155; margin-top:4px; }

    /* Right filters (sticky) */
    #filters{ grid-column:3; grid-row:1; position:sticky; top:14px; height:fit-content; display:flex; flex-direction:column; gap:14px; }
    label{ font-weight:900; color:#000; font-size:20px; }
    .in,.btn{ font-size:20px; padding:12px; border:3px solid var(--frame); border-radius:12px; background:#fff; color:#000; }
    .btn{ cursor:pointer; }
    .btn:hover{ background:#dbeafe; }

    /* Bottom revenue chart */
    #bottom{ grid-column:1 / -1; grid-row:2; }
    #chartRevenue{ width:100% !important; height:420px !important; } /* fixed height => no stretch */

    @media (max-width:1400px){
      .grid{ grid-template-columns: 1fr; grid-template-rows: auto auto auto; }
      #pies, #mapCard, #filters, #bottom{ grid-column:1; }
      #viewDiv{ min-height:56vh; }
      .kpis{ grid-template-columns: repeat(2,1fr); }
      .pies-grid{ grid-template-columns: repeat(3, minmax(120px,1fr)); }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="shadow">
      <h1>لوحة المؤشرات المالية للبلديات</h1>
      <div id="scope" class="chip">عرض جميع البلديات</div>
    </header>

    <!-- KPIs -->
    <section class="kpis">
      <div class="kpi shadow"><div class="label">إجمالي الإيرادات المستهدفة</div><div id="kpiTarget" class="value">—</div></div>
      <div class="kpi shadow"><div class="label">إجمالي الإيرادات المحصّلة</div><div id="kpiCollected" class="value">—</div></div>
      <div class="kpi shadow"><div class="label">نسبة تحقيق الإيرادات</div><div id="kpiAchPct" class="value">—</div></div>
      <div class="kpi shadow"><div class="label">متوسط الصرف</div><div id="kpiAvgSpend" class="value">—</div></div>
      <div class="kpi shadow"><div class="label">نسبة الرضا </div><div id="kpiSatisfaction" class="value">—</div></div>
    </section>

    <!-- Main grid -->
    <main class="grid">
      <!-- LEFT pies -->
      <aside id="pies">
        <div class="title">مؤشرات نعم/لا</div>
        <div class="pies-grid">
          <div class="pie-card shadow">
            <div class="pie-title">يوجد مطار</div>
            <div class="pie-wrap"><canvas id="yn_airport" class="pie-canvas"></canvas></div>
            <div class="legend-mini">نعم / لا</div>
          </div>
          <div class="pie-card shadow">
            <div class="pie-title">يوجد طريق دولي</div>
            <div class="pie-wrap"><canvas id="yn_intlroad" class="pie-canvas"></canvas></div>
            <div class="legend-mini">نعم / لا</div>
          </div>
          <div class="pie-card shadow">
            <div class="pie-title">يوجد مستشفى</div>
            <div class="pie-wrap"><canvas id="yn_hospital" class="pie-canvas"></canvas></div>
            <div class="legend-mini">نعم / لا</div>
          </div>
          <div class="pie-card shadow">
            <div class="pie-title">يوجد مدينة صناعية</div>
            <div class="pie-wrap"><canvas id="yn_industrial" class="pie-canvas"></canvas></div>
            <div class="legend-mini">نعم / لا</div>
          </div>
          <div class="pie-card shadow">
            <div class="pie-title">يوجد نادي</div>
            <div class="pie-wrap"><canvas id="yn_club" class="pie-canvas"></canvas></div>
            <div class="legend-mini">نعم / لا</div>
          </div>
          <div class="pie-card shadow">
            <div class="pie-title">حققت المستهدف</div>
            <div class="pie-wrap"><canvas id="yn_achieved" class="pie-canvas"></canvas></div>
            <div class="legend-mini">نعم / لا</div>
          </div>
        </div>
      </aside>

      <!-- CENTER map -->
      <section id="mapCard" class="card shadow">
        <div class="title">الخريطة</div>
        <div id="viewDiv" aria-label="الخريطة"></div>
      </section>

      <!-- RIGHT filters -->
      <aside id="filters" class="card shadow">
        <div class="title">المرشحات</div>
        <div><label for="filterCategory">الفئة</label><select id="filterCategory" class="in"></select></div>
        <div><label for="filterAchieved">تحقيق المستهدف</label>
          <select id="filterAchieved" class="in">
            <option value="">— الكل —</option>
            <option value="نعم">نعم</option>
            <option value="لا">لا</option>
          </select>
        </div>
        <div><label for="searchName">بحث بالبلدية</label><input id="searchName" class="in" placeholder="أدخل اسم البلدية" /></div>
        <div style="display:flex;gap:10px;"><button id="resetBtn" class="btn">إظهار الكل</button><button id="clearBtn" class="btn">مسح المرشحات</button></div>
      </aside>

      <!-- BOTTOM bar chart -->
      <section id="bottom" class="card shadow">
        <div class="title">الإيرادات المستهدفة مقابل المحصّلة</div>
        <canvas id="chartRevenue"></canvas>
      </section>
    </main>

    
  </div>

  <script>
    /* ================= Config & helpers ================= */
    const SERVICE_URL = "https://services5.arcgis.com/pbXsNv81cTqt6LrT/arcgis/rest/services/Map/FeatureServer/0";
    const FIELDS = {
      name: "البلدية",
      target: "الإيراد_المستهدف",
      collected: "الإيراد_المحصّل",
      achPct: "نسبة_الإيراد_",      // نستخدمه مباشرة ثم ×100 للعرض
      avgSpend: "متوسط_الصرف",      // ×100 للعرض
      satisfaction: "نسبة_الرضا",   // ×100 للعرض
      category: "الفئة",
      yn_airport: "يوجد_مطار",
      yn_intlroad: "يوجد_طريق_دولي",
      yn_hospital: "يوجد_مستشفى",
      yn_industrial: "يوجد_مدينة_صناعية",
      yn_club: "يوجد_نادي",
      yn_achieved: "حققت_المستهدف"
    };
    const $ = (id)=>document.getElementById(id);
    const fmt = (n,d=1)=>isNaN(n)?'—':new Intl.NumberFormat('ar-SA',{maximumFractionDigits:d}).format(n);
    const toNumber = (v)=>{ if(v==null) return 0; let s=String(v);
      const map={'٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9','٫':'.','٬':','};
      s=s.replace(/[٠-٩٫٬]/g,ch=>map[ch]??ch).replace(/,/g,''); const n=Number(s); return isNaN(n)?0:n; };

    let allRows=[], filtered=[], selectedName=null, highlight=null;
    let revenueChart=null;

    /* ================= KPI helpers ================= */
    function setTriangle(el, pct){
      el.innerHTML = "";
      const valSpan = document.createElement("span");
      valSpan.textContent = (pct==null) ? "—" : fmt(pct,1) + "%";
      el.appendChild(valSpan);
      if(pct==null) return;
      const tri = document.createElement("span");
      tri.className = "tri " + (pct >= 100 ? "tri-up" : "tri-down");
      el.appendChild(tri);
    }
    function updateKPIs(rows){
      const sum = (f)=>rows.reduce((s,r)=>s + toNumber(r[f]), 0);
      const avg = (f)=>rows.length ? (rows.reduce((s,r)=>s + toNumber(r[f]),0) / rows.length) : 0;

      const totalTarget    = sum(FIELDS.target);
      const totalCollected = sum(FIELDS.collected);
      const avgAchPct100   = avg(FIELDS.achPct) * 100;
      const avgSpend100    = avg(FIELDS.avgSpend) * 100;
      const avgSat100      = avg(FIELDS.satisfaction) * 100;

      $("kpiTarget").textContent = fmt(totalTarget,0);
      $("kpiCollected").textContent = fmt(totalCollected,0);
      setTriangle($("kpiAchPct"), isNaN(avgAchPct100)?null:avgAchPct100);
      $("kpiAvgSpend").textContent = fmt(avgSpend100,1) + "%";
      $("kpiSatisfaction").textContent = fmt(avgSat100,1) + "%";
    }

    /* ================= Charts ================= */
    function makePie(id, yes, no){
      const existing = Chart.getChart(id); if (existing) existing.destroy();
      return new Chart($(id), {
        type:"doughnut",
        data:{ labels:["نعم","لا"],
          datasets:[{ data:[yes,no], backgroundColor:["#22c55eCC","#ef4444CC"], borderColor:"#000", borderWidth:3 }] },
        options:{ responsive:true, maintainAspectRatio:true, plugins:{ legend:{ display:false } }, cutout:"60%" }
      });
    }
    function renderPies(rows){
      const norm = (v)=>["نعم","yes","y","true","1"].includes(String(v??"").toLowerCase()) ? "yes" : "no";
      const defs = [
        {id:"yn_airport", f:FIELDS.yn_airport},
        {id:"yn_intlroad", f:FIELDS.yn_intlroad},
        {id:"yn_hospital", f:FIELDS.yn_hospital},
        {id:"yn_industrial", f:FIELDS.yn_industrial},
        {id:"yn_club", f:FIELDS.yn_club},
        {id:"yn_achieved", f:FIELDS.yn_achieved}
      ];
      for(const {id,f} of defs){
        let yes=0,no=0; rows.forEach(r=> norm(r[f])==="yes" ? yes++ : no++);
        makePie(id, yes, no);
      }
    }
    function renderRevenueBar(rows, colorMap){
      const names=rows.map(r=>r[FIELDS.name]??"—");
      const targets=rows.map(r=>toNumber(r[FIELDS.target]));
      const collected=rows.map(r=>toNumber(r[FIELDS.collected]));
      const idx=targets.map((v,i)=>({i,v})).sort((a,b)=>b.v-a.v).slice(0,Math.min(12,targets.length)).map(o=>o.i);
      const labels=idx.map(i=>names[i]), tData=idx.map(i=>targets[i]), cData=idx.map(i=>collected[i]);
      const colColors=labels.map(n=>colorMap[n]||"rgba(14,165,233,0.6)");
      if(revenueChart){ revenueChart.destroy(); }
      revenueChart=new Chart($("chartRevenue"),{ type:"bar",
        data:{ labels, datasets:[
          {label:"المستهدف", data:tData, backgroundColor:"#9ca3af", borderColor:"#000", borderWidth:3, categoryPercentage:0.6, barPercentage:0.9},
          {label:"المحصّل", data:cData, backgroundColor:colColors, borderColor:"#000", borderWidth:3, categoryPercentage:0.6, barPercentage:0.9}
        ]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:"bottom"}}, scales:{y:{beginAtZero:true}} }
      });
      revenueChart.canvas.onclick=(evt)=>{
        const p=revenueChart.getElementsAtEventForMode(evt,'nearest',{intersect:true},true); if(!p.length) return;
        const i=p[0].index; const name=labels[i];
        window.dispatchEvent(new CustomEvent("select-mun",{detail:{name}}));
      };
    }

    /* ================= ArcGIS ================= */
    require([
      "esri/Map","esri/views/MapView","esri/layers/FeatureLayer","esri/renderers/UniqueValueRenderer","esri/layers/support/LabelClass"
    ], function(Map,MapView,FeatureLayer,UniqueValueRenderer,LabelClass){

      const layer=new FeatureLayer({ url:SERVICE_URL, outFields:["*"], popupEnabled:false });

      // labels
      layer.labelsVisible=true;
      layer.labelingInfo=[new LabelClass({
        labelExpressionInfo:{ expression:`$feature.${FIELDS.name}` },
        symbol:{ type:"text", color:"#000", haloColor:"#fff", haloSize:1.5, font:{size:14,family:"Cairo, Arial"} }
      })];

      const map=new Map({ basemap:"osm", layers:[layer] });
      const view=new MapView({ container:"viewDiv", map });

      const colorMap={};
      function hsl(h,s,l){ s=Math.max(0,Math.min(1,s)); l=Math.max(0,Math.min(1,l));
        const c=(1-Math.abs(2*l-1))*s, hp=h/60, x=c*(1-Math.abs(hp%2-1)); let [r,g,b]=[0,0,0];
        if(0<=hp&&hp<1)[r,g,b]=[c,x,0]; else if(1<=hp&&hp<2)[r,g,b]=[x,c,0];
        else if(2<=hp&&hp<3)[r,g,b]=[0,c,x]; else if(3<=hp&&hp<4)[r,g,b]=[0,x,c];
        else if(4<=hp&&hp<5)[r,g,b]=[x,0,c]; else [r,g,b]=[c,0,x];
        const m=l-c/2; r=Math.round((r+m)*255); g=Math.round((g+m)*255); b=Math.round((b+m)*255);
        return `rgba(${r},${g},${b},0.6)`; }  /* 40% شفافية */

      function uniqueRenderer(names){
        return new UniqueValueRenderer({
          field:FIELDS.name,
          defaultSymbol:{ type:"simple-fill", color:"rgba(200,200,200,0.6)", outline:{color:"#000", width:1.5}},
          uniqueValueInfos:names.map((nm,i)=>{ const col=colorMap[nm]||(colorMap[nm]=hsl(i*(360/Math.max(1,names.length)),0.65,0.55));
            return { value:nm, label:nm, symbol:{ type:"simple-fill", color:col, outline:{color:"#000", width:1.5}} }; })
        });
      }

      function populateFilters(){
        const el=$("filterCategory");
        el.innerHTML=`<option value="">— الكل —</option>`;
        [...new Set(allRows.map(r=>r[FIELDS.category]).filter(Boolean))].sort()
          .forEach(c=>{ const opt=document.createElement("option"); opt.value=c; opt.textContent=c; el.appendChild(opt); });
      }

      function applyFilters(){
        const cat=$("filterCategory").value, ach=$("filterAchieved").value, q=($("searchName").value||"").trim();
        filtered=allRows.filter(r=>{
          if(cat && r[FIELDS.category]!==cat) return false;
          if(ach && (r[FIELDS.yn_achieved]??"")!==ach) return false;
          if(q && !String(r[FIELDS.name]||"").includes(q)) return false;
          return true;
        });

        $("scope").textContent = selectedName
          ? `اسم البلدية: ${selectedName} : ${filtered.filter(r=>r[FIELDS.name]===selectedName).length}`
          : `عرض جميع البلديات (حسب المرشحات) — العدد: ${filtered.length}`;

        // لا نقوم بتصفية الخريطة عند النقر؛ فقط تمييز للحفاظ على ظهور الجميع.
        const rowsForDash = selectedName ? filtered.filter(r=>r[FIELDS.name]===selectedName) : filtered;

        updateKPIs(rowsForDash);
        renderRevenueBar(rowsForDash, colorMap);
        renderPies(filtered); // pies تعتمد على المرشحات فقط
      }

      // UI events
      $("filterCategory").addEventListener("change", applyFilters);
      $("filterAchieved").addEventListener("change", applyFilters);
      $("searchName").addEventListener("input", ()=>{ clearTimeout(window.__t); window.__t=setTimeout(applyFilters,250); });
      $("clearBtn").addEventListener("click", ()=>{ $("filterCategory").value=""; $("filterAchieved").value=""; $("searchName").value=""; selectedName=null; if(highlight) highlight.remove(); applyFilters(); });
      $("resetBtn").addEventListener("click", ()=>{ selectedName=null; if(highlight) highlight.remove(); applyFilters(); });

      // chart -> map selection
      window.addEventListener("select-mun", (e)=>{
        selectedName = e.detail?.name || null;
        applyFilters(); // تحديث المؤشرات فقط
        if(!selectedName) return;
        view.whenLayerView(layer).then(async (lv)=>{
          const res = await lv.queryFeatures({ where: `${FIELDS.name}='${String(selectedName).replace(/'/g,"''")}'` });
          if (highlight) highlight.remove();
          if (res.features.length){ highlight = lv.highlight(res.features[0]); view.goTo(res.features[0].geometry.extent.expand(1.5)).catch(()=>{}); }
        });
      });

      // init map + data
      view.when(async ()=>{
        await layer.when();
        const q = await layer.queryFeatures({ where:"1=1", outFields:["*"], returnGeometry:true });
        allRows = q.features.map(g => ({ ...g.attributes, OBJECTID:g.attributes.OBJECTID }));

        const names=[...new Set(allRows.map(r=>r[FIELDS.name]).filter(Boolean))];
        names.forEach((nm,i)=>{ if(!colorMap[nm]) colorMap[nm]=hsl(i*(360/Math.max(1,names.length)),0.65,0.55); });
        layer.renderer = uniqueRenderer(names);

        if (layer.fullExtent) view.goTo(layer.fullExtent.expand(1.1)).catch(()=>{});
        populateFilters();
        applyFilters();

        // map click -> highlight only (no filtering)
        view.on("click", async (evt)=>{
          const hit=await view.hitTest(evt);
          const g=hit.results.find(r=>r.graphic && r.graphic.layer===layer)?.graphic;
          if(!g){ selectedName=null; if(highlight) highlight.remove(); applyFilters(); return; }
          if(highlight) highlight.remove();
          view.whenLayerView(layer).then(lv=>{ highlight=lv.highlight(g); });
          selectedName=g.attributes[FIELDS.name]||null;
          applyFilters();
        });
      });
    });
  </script>
  <footer style="border-top:3px solid #000; padding:12px 18px; text-align:center; background:#e0f2fe; font-size:18px;">

<strong>Powered by : Eng. Mohaned</strong>
</footer>
</body>
</html>



